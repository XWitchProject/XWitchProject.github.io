<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Relua: Relua</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Relua
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="namespaceRelua.html">Relua</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="namespaceRelua.html">Relua</a> is a handwritten two-way parser and scripted code transformation engine for Lua, written in C#. It has the capability to read Lua source code into a runtime representation (AST), and write that runtime representation back into Lua source code with no semantic differences. The <a class="el" href="namespaceRelua_1_1Script.html">Relua.Script</a> subproject provides a runtime and an API for Lua scripts to transform any script in a fairly straightforward manner.</p>
<h1><a class="anchor" id="autotoc_md36"></a>
Lua Version</h1>
<p><a class="el" href="namespaceRelua.html">Relua</a> is created to work out of the box with Lua 5.1 and LuaJIT, however the design should make it fairly simple to add support for 5.2 and 5.3.</p>
<h1><a class="anchor" id="autotoc_md37"></a>
Parsing</h1>
<p><a class="el" href="namespaceRelua.html">Relua</a> does not use any library to aid the parsing. Instead, it implements everything from the bare primitives up to complex expressions in a procedural manner. While this does significantly increase the size and complexity of the code, it makes it much easier to modify the parser to suit various use cases and to implement language quirks that would require ugly hacks to implement on top of primitives provided by parsing engines.</p>
<h1><a class="anchor" id="autotoc_md38"></a>
Why not just emit bytecode?</h1>
<p>A significant portion of software with some form of Lua scripting makes use of sandboxing. This usually includes disabling the ability to load bytecode (due to possible exploits), which would significantly decrease the usefulness of a tool like this, especially for videogame modding and similar. Reading and writing code is also much more natural than operating on bytecode.</p>
<h1><a class="anchor" id="autotoc_md39"></a>
Performance</h1>
<p>According to my own limited testing with GNU <code>time</code> and a small test program, <a class="el" href="namespaceRelua.html">Relua</a> is about six times faster at parsing files and chunks than the parser used by the archived <a href="https://github.com/frabert/NetLua/tree/master/NetLua">NetLua</a> project. It also uses on average a bit less than half of the memory (likely due to avoiding the use of so many intermediate parser objects).</p>
<p>On my machine, it takes NetLua on average 1.3 sec to parse a 750K file, while <a class="el" href="namespaceRelua.html">Relua</a> reads that same file in about 0.2-0.3 sec. It takes about an extra 0.1 sec to write back the source code from the AST, meaning that by the time NetLua has parsed a file, a program could have already read a file with <a class="el" href="namespaceRelua.html">Relua</a>, parsed it, modified the AST and written it back.</p>
<h1><a class="anchor" id="autotoc_md40"></a>
Relua.Script</h1>
<p><a class="el" href="namespaceRelua_1_1Script.html">Relua.Script</a> runs on top of the standard Lua 5.1 implementation (or LuaJIT) to expose an API for AST node manipulation. In essence, <a class="el" href="namespaceRelua_1_1Script.html">Relua.Script</a> enables you to use a Lua script to modify a Lua script using its runtime representation. This combined with <a class="el" href="namespaceRelua.html">Relua</a>'s ability to write the AST back into code makes for a very powerful and extensible transformation engine.</p>
<h2><a class="anchor" id="autotoc_md41"></a>
API</h2>
<p><a href="https://github.com/XWitchProject/Relua/blob/master/API.md">Check out the detailed API documentation here</a>.</p>
<h2><a class="anchor" id="autotoc_md42"></a>
Example</h2>
<div class="fragment"><div class="line">function FunctionDefinition(node)</div>
<div class="line">    local new_block = astnew(&quot;Block&quot;)</div>
<div class="line"> </div>
<div class="line">    local block_copy = astnew(&quot;Block&quot;)</div>
<div class="line">    node.Block.Statements:iter(function(i, stat)</div>
<div class="line">        enter(stat)</div>
<div class="line">        block_copy.Statements:add(stat)</div>
<div class="line">    end)</div>
<div class="line"> </div>
<div class="line">    local pcall_call = aststat(&quot;local result, err = pcall(function() end)&quot;)</div>
<div class="line">    pcall_call.Values[1].Arguments[1].Block = block_copy</div>
<div class="line">    new_block.Statements:add(pcall_call)</div>
<div class="line"> </div>
<div class="line">    local pcall_check = aststat(&quot;if err ~= nil then error(err) end&quot;)</div>
<div class="line">    pcall_check.MainIf.Block.Statements:insert(1, aststat(&quot;print(&#39;do something here&#39;)&quot;))</div>
<div class="line">    new_block.Statements:add(pcall_check)</div>
<div class="line"> </div>
<div class="line">    new_block.Statements:add(aststat(&quot;return result&quot;))</div>
<div class="line"> </div>
<div class="line">    node.Block = new_block</div>
<div class="line">end</div>
</div><!-- fragment --><p>Before: </p><div class="fragment"><div class="line">function test()</div>
<div class="line">        print(&quot;Hello, world!&quot;)</div>
<div class="line">        print(&quot;blah&quot;)</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">test()</div>
</div><!-- fragment --><p>After: </p><div class="fragment"><div class="line">function test()</div>
<div class="line">    local result, err = pcall(function()</div>
<div class="line">        print(&quot;Hello, world!&quot;)</div>
<div class="line">        print(&quot;blah&quot;)</div>
<div class="line">    end)</div>
<div class="line">    if (err ~= nil) then</div>
<div class="line">        print(&quot;do something here&quot;)</div>
<div class="line">        error(err)</div>
<div class="line">    end</div>
<div class="line">    return result</div>
<div class="line">end</div>
<div class="line">test()</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
